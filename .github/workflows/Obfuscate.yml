name: Update and Obfuscate Worker

on:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©19:00 UTCï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥03:00ï¼‰è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main  # ä¸»åˆ†æ”¯æ›´æ–°æ—¶ä¹Ÿè¿è¡Œ

permissions:
  contents: write

jobs:
  update-and-obfuscate:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub ä»¤ç‰Œ

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'  # ä½¿ç”¨é•¿æœŸæ”¯æŒç‰ˆæœ¬
          cache: 'npm'  # ç¼“å­˜ npm ä¾èµ–

      - name: å®‰è£…ä¾èµ–
        uses: nick-fields/retry@v2  # æ·»åŠ é‡è¯•æœºåˆ¶
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            npm install -g javascript-obfuscator@4.0.0  # é”å®šç‰ˆæœ¬
            sudo apt-get update && sudo apt-get install -y jq curl unzip

      - name: è·å–æœ€æ–° release tag
        id: get_release
        run: |
          set -euo pipefail  # å¯ç”¨ä¸¥æ ¼æ¨¡å¼
          
          # è·å–æœ€æ–° release ä¿¡æ¯
          echo "æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯..."
          API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest"
          RESPONSE=$(curl -s -H "Accept: application/vnd.github.v3+json" "$API_URL")
          
          # æ£€æŸ¥ API å“åº”
          if echo "$RESPONSE" | jq -e '.message' >/dev/null; then
            echo "API é”™è¯¯: $(echo "$RESPONSE" | jq -r '.message')"
            exit 1
          fi
          
          latest_tag=$(echo "$RESPONSE" | jq -r '.tag_name')
          
          if [ "$latest_tag" = "null" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯"
            exit 1
          fi
          
          echo "æœ€æ–°ç‰ˆæœ¬: $latest_tag"
          echo "latest_tag=$latest_tag" >> $GITHUB_ENV

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        id: check_version
        run: |
          set -euo pipefail
          
          # è·å–å½“å‰ç‰ˆæœ¬
          if [ -f "version.txt" ]; then
            current_version=$(cat version.txt | tr -d '\n' | tr -d '\r')
          else
            current_version=""
            echo "æœªæ‰¾åˆ°ç‰ˆæœ¬æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°ç‰ˆæœ¬"
          fi
          
          echo "å½“å‰ç‰ˆæœ¬: $current_version"
          echo "æœ€æ–°ç‰ˆæœ¬: ${{ env.latest_tag }}"
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "$current_version" != "${{ env.latest_tag }}" ]; then
            echo "éœ€è¦æ›´æ–°"
            echo "should_update=true" >> $GITHUB_ENV
          else
            echo "æ— éœ€æ›´æ–°"
            echo "should_update=false" >> $GITHUB_ENV
          fi

      - name: ä¸‹è½½å¹¶æ··æ·†ä»£ç 
        if: env.should_update == 'true'
        run: |
          set -euo pipefail
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          trap 'rm -rf "$TEMP_DIR"' EXIT  # ç¡®ä¿æ¸…ç†ä¸´æ—¶ç›®å½•
          
          # ä¸‹è½½æœ€æ–° worker.js
          echo "ä¸‹è½½æœ€æ–° worker.js ç‰ˆæœ¬ ${{ env.latest_tag }}..."
          DOWNLOAD_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/${{ env.latest_tag }}/worker.js"
          
          # ä½¿ç”¨é‡è¯•æœºåˆ¶ä¸‹è½½
          for i in {1..3}; do
            curl -L -o "$TEMP_DIR/origin.js" "$DOWNLOAD_URL" && break
            echo "ä¸‹è½½å°è¯• $i å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
            sleep 5
          done
          
          # éªŒè¯ä¸‹è½½æ–‡ä»¶
          if [ ! -f "$TEMP_DIR/origin.js" ]; then
            echo "é”™è¯¯: ä¸‹è½½æ–‡ä»¶å¤±è´¥"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "ä¸‹è½½æˆåŠŸ:"
          ls -l "$TEMP_DIR/origin.js"
          
          # æ··æ·† JS ä»£ç 
          echo "å¼€å§‹æ··æ·†ä»£ç ..."
          javascript-obfuscator "$TEMP_DIR/origin.js" --output "$TEMP_DIR/_worker.js" \
            --compact true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-threshold 0.75 \
            --string-array-encoding base64 \
            --transform-object-keys true \
            --split-strings true \
            --simplify true \
            --source-map false \
            --self-defending true
          
          # éªŒè¯æ··æ·†ç»“æœ
          if [ ! -f "$TEMP_DIR/_worker.js" ]; then
            echo "é”™è¯¯: æ··æ·†æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c %s "$TEMP_DIR/_worker.js")
          echo "æ··æ·†åæ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          
          # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
          echo "// Version: ${{ env.latest_tag }}" >> "$TEMP_DIR/_worker.js"
          echo "// Obfuscated on: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$TEMP_DIR/_worker.js"
          
          # ç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®
          mv "$TEMP_DIR/_worker.js" .
          echo "${{ env.latest_tag }}" > version.txt
          
          echo "æ›´æ–°å®Œæˆ"

      - name: æ£€æŸ¥å˜æ›´
        id: check_changes
        if: env.should_update == 'true'
        run: |
          if [[ $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤æ›´æ”¹
        if: env.should_update == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ Update to BPB Panel v${{ env.latest_tag }}"
          commit_author: GitHub Actions <actions@github.com>
          branch: ${{ github.ref_name }}
          file_pattern: |
            _worker.js
            version.txt
          push_options: --force

      - name: ä¸Šä¼ æ··æ·†æ–‡ä»¶ä½œä¸ºå·¥ä»¶
        if: success() && env.should_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: obfuscated-worker
          path: _worker.js
          retention-days: 7
