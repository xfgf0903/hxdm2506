name: Update and Obfuscate Worker

on:
  schedule:
    - cron: '0 8 * * *'  # 转换为北京时间 04:00 AM (UTC+8)
  workflow_dispatch:      # 允许手动触发

permissions:
  contents: read  # 最小权限原则
  packages: write

jobs:
  update-and-obfuscate:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # 设置超时保护

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x  # 指定LTS版本
          cache: 'npm'      # 启用npm缓存

      - name: Install dependencies
        run: |
          npm ci --prefer-offline  # 离线优先安装
          npm install javascript-obfuscator@3.3.0  # 固定版本

      - name: Fetch latest release
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching latest BPB Worker release..."
          curl --fail --silent --show-error \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest" | \
            jq -r '.tag_name' > latest_tag.txt

      - name: Validate release fetch
        run: |
          if [ ! -s latest_tag.txt ]; then
            echo "Error: Failed to fetch release tag" >&2
            exit 1
          fi

      - name: Read current version
        id: read_version
        run: |
          current_version=$(cat version.txt 2>/dev/null || echo "")
          echo "Current version: ${current_version:-N/A}"

      - name: Compare versions
        id: check_update
        run: |
          latest_tag=$(cat latest_tag.txt)
          if [ "$current_version" = "$latest_tag" ]; then
            echo "No update needed"
            exit 0
          else
            echo "New version available: $latest_tag"
          fi

      - name: Download worker.js
        id: download_worker
        run: |
          echo "Downloading worker.js..."
          curl --fail --location --silent --show-error \
            "https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/${latest_tag}/worker.js" \
            -o origin.js

      - name: Validate download
        run: |
          [ -s origin.js ] && echo "Valid download" || \
          { echo "Download failed"; exit 1; }

      - name: Obfuscate JavaScript
        id: obfuscate
        env:
          OBFUSCATOR_CONFIG: |
            {
              compact: true,
              controlFlowFlattening: false,
              deadCodeInjection: false,
              identifierNamesGenerator: "mangled",
              renameGlobals: true,
              stringArray: true,
              stringArrayEncoding: ["base64"],
              stringArrayThreshold: 0.6,
              selfDefending: true,
              debugProtection: true,
              unicodeEscapeSequence: false
            }
        run: |
          echo "${{ env.OBFUSCATOR_CONFIG }}" > config.json
          javascript-obfuscator origin.js --config config.json --output _worker.js

      - name: Add integrity check
        run: |
          echo "// SHA256: $(sha256sum _worker.js | cut -d' ' -f1)" >> _worker.js

      - name: Update version
        run: |
          echo "${latest_tag}" > version.txt
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: "[Auto] Update BPB Worker to v${{ env.latest_tag }}"
          commit_author: "GitHub Actions <actions@github.com>"
          push_options: "--force-with-lease"

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: obfuscated-worker
          path: _worker.js
          retention-days: 7
